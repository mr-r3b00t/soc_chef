<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row =>
                    row.some(cell => cell !== '' && cell !== null && cell !== undefined)
                );

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Planning Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
            background-color: #ffffff;
            color: #000000;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        h1 {
            margin-bottom: 10px;
        }
        h2, h3 {
            margin-top: 0;
            margin-bottom: 0;
            display: inline-block;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .activities-section, .roadmap-section, .summary-section {
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            background-color: #ffffff;
            transition: height 0.2s ease;
        }
        body.dark-mode .activities-section, body.dark-mode .roadmap-section, body.dark-mode .summary-section {
            border-color: #555;
            background-color: #2a2a2a;
        }
        .activities-section.minimized, .roadmap-section.minimized, .summary-section.minimized {
            height: 40px;
            overflow: hidden;
        }
        .activities-section:not(.minimized), .roadmap-section:not(.minimized) {
            flex: 1;
            overflow-y: auto;
        }
        .summary-section:not(.minimized) {
            overflow-y: auto;
        }
        .both-maximized .activities-section:not(.minimized),
        .both-maximized .roadmap-section:not(.minimized) {
            flex: 0 0 50%;
        }
        .buttons-section {
            padding: 10px;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            background-color: #ffffff;
        }
        body.dark-mode table {
            background-color: #2a2a2a;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            min-width: 80px;
        }
        body.dark-mode th, body.dark-mode td {
            border-color: #555;
        }
        input, select {
            width: 100%;
            box-sizing: border-box;
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #ddd;
        }
        body.dark-mode input, body.dark-mode select {
            background-color: #333;
            color: #ffffff;
            border-color: #555;
        }
        .staff-count-input {
            width: 60px;
        }
        button, .button-label {
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            text-align: center;
        }
        body.dark-mode button, body.dark-mode .button-label {
            background-color: #444;
            border-color: #666;
            color: #ffffff;
        }
        #summary {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #summary table {
            width: auto;
            font-size: 12px;
            margin: 0;
            border-collapse: collapse;
            background-color: #ffffff;
        }
        body.dark-mode #summary table {
            background-color: #2a2a2a;
        }
        #summary th, #summary td {
            padding: 4px 8px;
            border: 1px solid #ddd;
            text-align: left;
            white-space: nowrap;
        }
        body.dark-mode #summary th, body.dark-mode #summary td {
            border-color: #555;
        }
        #summary th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        body.dark-mode #summary th {
            background-color: #444;
        }
        select[multiple] {
            height: 100px;
        }
        .calculated-cost {
            background-color: #f0f0f0;
            pointer-events: none;
        }
        body.dark-mode .calculated-cost {
            background-color: #444;
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        body.dark-mode .theme-toggle {
            color: #ffd700;
        }
        .gantt .bar-wrapper .bar.internal {
            fill: #0000ff !important;
        }
        .gantt .bar-wrapper .bar.external {
            fill: #ff0000 !important;
        }
        .gantt .bar-wrapper .bar.mixed {
            fill: #800080 !important;
        }
        body.dark-mode .gantt .bar-wrapper .bar.internal {
            fill: #1e90ff !important;
        }
        body.dark-mode .gantt .bar-wrapper .bar.external {
            fill: #ff4040 !important;
        }
        body.dark-mode .gantt .bar-wrapper .bar.mixed {
            fill: #c71585 !important;
        }
        body.dark-mode .gantt .bar-label {
            fill: #ffffff;
        }
        body.dark-mode .gantt .grid-header {
            fill: #2a2a2a;
            stroke: #555;
        }
        body.dark-mode .gantt .grid-row {
            fill: #1e1e1e;
        }
        body.dark-mode .gantt .tick {
            stroke: #555;
        }
        .gantt .day-letter {
            font-size: 12px;
            text-anchor: middle;
            fill: #000;
        }
        body.dark-mode .gantt .day-letter {
            fill: #fff;
        }
        #import-tasks {
            display: none;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .toggle-btn {
            font-size: 14px;
            padding: 3px 8px;
            line-height: 1;
            width: 30px;
            min-width: 30px;
            text-align: center;
        }
        body.dark-mode .toggle-btn {
            background-color: #444;
            border-color: #666;
            color: #ffd700;
        }
        .section-content {
            transition: all 0.2s ease;
        }
        .minimized .section-content {
            display: none;
        }
    </style>
</head>
<body>
    <div id="theme-toggle" class="theme-toggle">ðŸ•´</div>
    <h1>Project Planning Tool</h1>
    <div class="main-container">
        <div class="activities-section">
            <div class="section-header">
                <h2>Activities</h2>
                <button id="toggle-activities" class="toggle-btn">â–²</button>
            </div>
            <div id="activities-content" class="section-content">
                <table id="activities-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phase</th>
                            <th>Owner</th>
                            <th>Equipment/Services Cost (Â£)</th>
                            <th>Day Rate (Â£)</th>
                            <th>Internal Staff Count</th>
                            <th>External Staff Count</th>
                            <th>Allow Weekend Work</th>
                            <th>Effort (days)</th>
                            <th>Calculated Cost (Â£)</th>
                            <th>Desired Start Date</th>
                            <th>Dependencies</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="buttons-section">
            <button id="add-activity">Add Activity</button>
            <button id="clear-all">Clear All Tasks</button>
            <button id="export-tasks">Export Tasks</button>
            <label for="import-tasks" class="button-label">Import Tasks</label>
            <input type="file" id="import-tasks" accept=".json">
        </div>
        <div class="roadmap-section">
            <div class="section-header">
                <h2>Roadmap</h2>
                <button id="toggle-roadmap" class="toggle-btn">â–²</button>
            </div>
            <div id="roadmap-content" class="section-content">
                <div class="summary-section">
                    <div class="section-header">
                        <h3>Project Time and Costs</h3>
                        <button id="toggle-summary" class="toggle-btn">â–²</button>
                    </div>
                    <div id="summary-content" class="section-content">
                        <div id="summary"></div>
                    </div>
                </div>
                <div id="gantt"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>
    <script type="text/javascript">
        let activities = [];
        let idCounter = 1;
        const DEFAULT_DAY_RATE = 1000;

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').textContent = 'ðŸ’¡';
        } else {
            document.getElementById('theme-toggle').textContent = 'ðŸ•´';
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.getElementById('theme-toggle').textContent = isDarkMode ? 'ðŸ’¡' : 'ðŸ•´';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });

        const activitiesSection = document.querySelector('.activities-section');
        const roadmapSection = document.querySelector('.roadmap-section');
        const summarySection = document.querySelector('.summary-section');
        const mainContainer = document.querySelector('.main-container');
        const toggleActivitiesBtn = document.getElementById('toggle-activities');
        toggleActivitiesBtn.addEventListener('click', () => {
            activitiesSection.classList.toggle('minimized');
            toggleActivitiesBtn.innerHTML = activitiesSection.classList.contains('minimized') ? 'â–¼' : 'â–²';
            updateSectionHeights();
        });

        const toggleRoadmapBtn = document.getElementById('toggle-roadmap');
        toggleRoadmapBtn.addEventListener('click', () => {
            roadmapSection.classList.toggle('minimized');
            toggleRoadmapBtn.innerHTML = roadmapSection.classList.contains('minimized') ? 'â–¼' : 'â–²';
            updateSectionHeights();
        });

        const toggleSummaryBtn = document.getElementById('toggle-summary');
        toggleSummaryBtn.addEventListener('click', () => {
            summarySection.classList.toggle('minimized');
            toggleSummaryBtn.innerHTML = summarySection.classList.contains('minimized') ? 'â–¼' : 'â–²';
        });

        function updateSectionHeights() {
            const isActivitiesMinimized = activitiesSection.classList.contains('minimized');
            const isRoadmapMinimized = roadmapSection.classList.contains('minimized');
            if (!isActivitiesMinimized && !isRoadmapMinimized) {
                mainContainer.classList.add('both-maximized');
            } else {
                mainContainer.classList.remove('both-maximized');
            }
        }

        function addWorkDays(startDay, effort, allowWeekendWork) {
            let currentDay = startDay;
            let daysAdded = 0;
            while (daysAdded < effort) {
                currentDay++;
                const date = new Date(2023, 0, 1 + currentDay);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                if (allowWeekendWork || !isWeekend) {
                    daysAdded++;
                }
            }
            return currentDay;
        }

        function renderActivitiesTable() {
            const tbody = document.querySelector('#activities-table tbody');
            tbody.innerHTML = '';
            activities.forEach(activity => {
                const row = document.createElement('tr');
                let dependencyOptions = `<option value="" disabled ${activity.predecessors.length === 0 ? "selected" : ""}>Select dependencies</option>`;
                activities.forEach(other => {
                    if (other.id !== activity.id) {
                        const selected = activity.predecessors.includes(other.id) ? 'selected' : '';
                        dependencyOptions += `<option value="${other.id}" ${selected}>Activity ${other.id}: ${other.name || 'Unnamed'}</option>`;
                    }
                });
                const calculatedCost = activity.equipmentCost + activity.effort * (
                    activity.internalStaffCount * activity.dayRate * 0.5 +
                    activity.externalStaffCount * activity.dayRate
                );
                row.innerHTML = `
                    <td>${activity.id}</td>
                    <td><input type="text" value="${activity.name}" data-id="${activity.id}" class="name-input"></td>
                    <td><input type="text" value="${activity.phase}" data-id="${activity.id}" class="phase-input"></td>
                    <td><input type="text" value="${activity.owner}" data-id="${activity.id}" class="owner-input"></td>
                    <td><input type="number" value="${activity.equipmentCost}" data-id="${activity.id}" class="equipment-cost-input" min="0" step="0.01"></td>
                    <td><input type="number" value="${activity.dayRate}" data-id="${activity.id}" class="day-rate-input" min="0" step="0.01"></td>
                    <td><input type="number" value="${activity.internalStaffCount}" data-id="${activity.id}" class="staff-count-input internal-staff-count-input" min="0" step="1"></td>
                    <td><input type="number" value="${activity.externalStaffCount}" data-id="${activity.id}" class="staff-count-input external-staff-count-input" min="0" step="1"></td>
                    <td><input type="checkbox" ${activity.allowWeekendWork ? 'checked' : ''} data-id="${activity.id}" class="weekend-work-input"></td>
                    <td><input type="number" value="${activity.effort}" data-id="${activity.id}" class="effort-input" min="0.25" step="0.01"></td>
                    <td><input type="text" value="${calculatedCost.toFixed(2)}" class="calculated-cost" readonly></td>
                    <td><input type="date" value="${activity.desiredStartDate || ''}" data-id="${activity.id}" class="start-date-input"></td>
                    <td><select multiple data-id="${activity.id}" class="dependency-input">${dependencyOptions}</select></td>
                    <td><button data-id="${activity.id}" class="delete-btn">Delete</button></td>
                `;
                tbody.appendChild(row);
            });

            attachEventListeners();
        }

        function attachEventListeners() {
            document.querySelectorAll('.name-input').forEach(input => {
                input.removeEventListener('change', handleNameChange);
                input.addEventListener('change', handleNameChange);
            });
            document.querySelectorAll('.phase-input').forEach(input => {
                input.removeEventListener('change', handlePhaseChange);
                input.addEventListener('change', handlePhaseChange);
            });
            document.querySelectorAll('.owner-input').forEach(input => {
                input.removeEventListener('change', handleOwnerChange);
                input.addEventListener('change', handleOwnerChange);
            });
            document.querySelectorAll('.equipment-cost-input').forEach(input => {
                input.removeEventListener('change', handleEquipmentCostChange);
                input.addEventListener('change', handleEquipmentCostChange);
            });
            document.querySelectorAll('.day-rate-input').forEach(input => {
                input.removeEventListener('change', handleDayRateChange);
                input.addEventListener('change', handleDayRateChange);
            });
            document.querySelectorAll('.internal-staff-count-input').forEach(input => {
                input.removeEventListener('change', handleInternalStaffCountChange);
                input.addEventListener('change', handleInternalStaffCountChange);
            });
            document.querySelectorAll('.external-staff-count-input').forEach(input => {
                input.removeEventListener('change', handleExternalStaffCountChange);
                input.addEventListener('change', handleExternalStaffCountChange);
            });
            document.querySelectorAll('.weekend-work-input').forEach(input => {
                input.removeEventListener('change', handleWeekendWorkChange);
                input.addEventListener('change', handleWeekendWorkChange);
            });
            document.querySelectorAll('.effort-input').forEach(input => {
                input.removeEventListener('change', handleEffortChange);
                input.addEventListener('change', handleEffortChange);
            });
            document.querySelectorAll('.start-date-input').forEach(input => {
                input.removeEventListener('change', handleStartDateChange);
                input.addEventListener('change', handleStartDateChange);
            });
            document.querySelectorAll('.dependency-input').forEach(select => {
                select.removeEventListener('change', handleDependencyChange);
                select.addEventListener('change', handleDependencyChange);
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.removeEventListener('click', handleDelete);
                btn.addEventListener('click', handleDelete);
            });
            document.getElementById('clear-all').removeEventListener('click', handleClearAll);
            document.getElementById('clear-all').addEventListener('click', handleClearAll);
            document.getElementById('add-activity').removeEventListener('click', handleAddActivity);
            document.getElementById('add-activity').addEventListener('click', handleAddActivity);
            document.getElementById('export-tasks').removeEventListener('click', handleExportTasks);
            document.getElementById('export-tasks').addEventListener('click', handleExportTasks);
            document.getElementById('import-tasks').removeEventListener('change', handleImportTasks);
            document.getElementById('import-tasks').addEventListener('change', handleImportTasks);
        }

        function handleNameChange(e) {
            const id = parseInt(e.target.dataset.id);
            const activity = activities.find(a => a.id === id);
            activity.name = e.target.value || "Unnamed";
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handlePhaseChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).phase = e.target.value;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleOwnerChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).owner = e.target.value;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleEquipmentCostChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).equipmentCost = parseFloat(e.target.value) || 0;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleDayRateChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).dayRate = parseFloat(e.target.value) || DEFAULT_DAY_RATE;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleInternalStaffCountChange(e) {
            const id = parseInt(e.target.dataset.id);
            const activity = activities.find(a => a.id === id);
            activity.internalStaffCount = parseInt(e.target.value) || 0;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleExternalStaffCountChange(e) {
            const id = parseInt(e.target.dataset.id);
            const activity = activities.find(a => a.id === id);
            activity.externalStaffCount = parseInt(e.target.value) || 0;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleWeekendWorkChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).allowWeekendWork = e.target.checked;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleEffortChange(e) {
            const id = parseInt(e.target.dataset.id);
            const activity = activities.find(a => a.id === id);
            const newEffort = parseFloat(e.target.value);
            activity.effort = isNaN(newEffort) || newEffort < 0.25 ? 0.25 : newEffort;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleStartDateChange(e) {
            const id = parseInt(e.target.dataset.id);
            activities.find(a => a.id === id).desiredStartDate = e.target.value;
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleDependencyChange(e) {
            const id = parseInt(e.target.dataset.id);
            const activity = activities.find(a => a.id === id);
            activity.predecessors = Array.from(e.target.selectedOptions, option => parseInt(option.value)).filter(val => !isNaN(val));
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleDelete(e) {
            const id = parseInt(e.target.dataset.id);
            activities = activities.filter(a => a.id !== id);
            activities.forEach(a => {
                a.predecessors = a.predecessors.filter(pred => pred !== id);
            });
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleClearAll() {
            activities = [];
            idCounter = 1;
            renderActivitiesTable();
            updateRoadmap();
        }

        function handleAddActivity() {
            const newActivity = {
                id: idCounter++,
                name: "Unnamed",
                phase: "",
                owner: "None",
                equipmentCost: 0,
                dayRate: DEFAULT_DAY_RATE,
                internalStaffCount: 0,
                externalStaffCount: 1,
                allowWeekendWork: false,
                effort: 1,
                desiredStartDate: '',
                predecessors: [],
                start: null,
                end: null
            };
            activities.push(newActivity);
            renderActivitiesTable();
            try {
                computeSchedule();
                updateRoadmap();
            } catch (error) {
                alert('Error updating roadmap: ' + error.message);
            }
        }

        function handleExportTasks() {
            const exportData = activities.map(activity => ({
                id: activity.id,
                name: activity.name,
                phase: activity.phase,
                owner: activity.owner,
                equipmentCost: activity.equipmentCost,
                dayRate: activity.dayRate,
                internalStaffCount: activity.internalStaffCount,
                externalStaffCount: activity.externalStaffCount,
                allowWeekendWork: activity.allowWeekendWork,
                effort: activity.effort,
                desiredStartDate: activity.desiredStartDate,
                predecessors: activity.predecessors
            }));
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'roadmap_tasks.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportTasks(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.json')) {
                alert('Please upload a .json file.');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid format: Expected an array of tasks.');
                    }
                    const requiredFields = [
                        'id', 'name', 'owner', 'equipmentCost', 'dayRate',
                        'allowWeekendWork', 'effort', 'desiredStartDate', 'predecessors'
                    ];
                    for (const task of importedData) {
                        for (const field of requiredFields) {
                            if (!(field in task)) {
                                throw new Error(`Missing required field: ${field}`);
                            }
                        }
                        if (typeof task.id !== 'number' || task.id <= 0) {
                            throw new Error('Invalid ID: Must be a positive number.');
                        }
                        if (typeof task.name !== 'string') {
                            throw new Error('Invalid name: Must be a string.');
                        }
                        if (!('phase' in task)) {
                            task.phase = '';
                        } else if (typeof task.phase !== 'string') {
                            throw new Error('Invalid phase: Must be a string.');
                        }
                        if (typeof task.owner !== 'string') {
                            throw new Error('Invalid owner: Must be a string.');
                        }
                        if (typeof task.equipmentCost !== 'number' || task.equipmentCost < 0) {
                            throw new Error('Invalid equipmentCost: Must be a non-negative number.');
                        }
                        if (typeof task.dayRate !== 'number' || task.dayRate <= 0) {
                            throw new Error('Invalid dayRate: Must be a positive number.');
                        }
                        if (typeof task.allowWeekendWork !== 'boolean') {
                            throw new Error('Invalid allowWeekendWork: Must be a boolean.');
                        }
                        if (typeof task.effort !== 'number' || task.effort <= 0) {
                            throw new Error('Invalid effort: Must be a positive number.');
                        }
                        if (task.desiredStartDate && !/^\d{4}-\d{2}-\d{2}$/.test(task.desiredStartDate)) {
                            throw new Error('Invalid desiredStartDate: Must be in YYYY-MM-DD format or empty.');
                        }
                        if (!Array.isArray(task.predecessors) || !task.predecessors.every(id => typeof id === 'number' && id > 0)) {
                            throw new Error('Invalid predecessors: Must be an array of positive numbers.');
                        }
                        if ('isInternal' in task) {
                            task.internalStaffCount = task.isInternal ? 1 : 0;
                            task.externalStaffCount = task.isInternal ? 0 : 1;
                            delete task.isInternal;
                        } else {
                            if (!('internalStaffCount' in task)) task.internalStaffCount = 0;
                            if (!('externalStaffCount' in task)) task.externalStaffCount = 1;
                        }
                        if (typeof task.internalStaffCount !== 'number' || task.internalStaffCount < 0) {
                            throw new Error('Invalid internalStaffCount: Must be a non-negative number.');
                        }
                        if (typeof task.externalStaffCount !== 'number' || task.externalStaffCount < 0) {
                            throw new Error('Invalid externalStaffCount: Must be a non-negative number.');
                        }
                    }
                    const idSet = new Set(importedData.map(task => task.id));
                    if (idSet.size !== importedData.length) {
                        throw new Error('Duplicate IDs detected.');
                    }
                    for (const task of importedData) {
                        for (const predId of task.predecessors) {
                            if (!idSet.has(predId)) {
                                throw new Error(`Invalid predecessor ID ${predId}: Not found in task list.`);
                            }
                        }
                    }
                    activities = importedData.map(task => ({
                        ...task,
                        start: null,
                        end: null
                    }));
                    idCounter = Math.max(...activities.map(a => a.id)) + 1;
                    renderActivitiesTable();
                    try {
                        computeSchedule();
                        updateRoadmap();
                    } catch (error) {
                        alert('Error scheduling imported tasks: ' + error.message);
                        activities = [];
                        idCounter = 1;
                        renderActivitiesTable();
                        document.getElementById('summary').innerHTML = '<p>No tasks loaded.</p>';
                        document.getElementById('gantt').innerHTML = '';
                    }
                } catch (error) {
                    alert('Error importing tasks: ' + error.message);
                    activities = [];
                    idCounter = 1;
                    renderActivitiesTable();
                    document.getElementById('summary').innerHTML = '<p>No tasks loaded.</p>';
                    document.getElementById('gantt').innerHTML = '';
                }
                e.target.value = '';
            };
            reader.onerror = function() {
                alert('Error reading file.');
                e.target.value = '';
                activities = [];
                idCounter = 1;
                renderActivitiesTable();
                document.getElementById('summary').innerHTML = '<p>No tasks loaded.</p>';
                document.getElementById('gantt').innerHTML = '';
            };
            reader.readAsText(file);
        }

        function updateRoadmap() {
            if (activities.length === 0) {
                document.getElementById('summary').innerHTML = '<p>No tasks loaded.</p>';
                document.getElementById('gantt').innerHTML = '';
                return;
            }

            const totalCost = activities.reduce((sum, a) => {
                return sum + a.equipmentCost + a.effort * (
                    a.internalStaffCount * a.dayRate * 0.5 +
                    a.externalStaffCount * a.dayRate
                );
            }, 0);
            const internalCost = activities.reduce((sum, a) => {
                return sum + a.effort * a.internalStaffCount * a.dayRate * 0.5;
            }, 0);
            const externalCost = activities.reduce((sum, a) => {
                return sum + a.effort * a.externalStaffCount * a.dayRate;
            }, 0);
            const internalStaffTotal = activities.reduce((sum, a) => sum + a.internalStaffCount, 0);
            const externalStaffTotal = activities.reduce((sum, a) => sum + a.externalStaffCount, 0);
            const internalEffort = activities
                .filter(a => a.internalStaffCount > 0)
                .reduce((sum, a) => sum + a.effort, 0);
            const externalEffort = activities
                .filter(a => a.externalStaffCount > 0)
                .reduce((sum, a) => sum + a.effort, 0);
            const minStart = Math.min(...activities.map(a => a.start));
            const maxEnd = Math.max(...activities.map(a => a.end));
            const totalDuration = maxEnd - minStart + 1;
            const totalEffort = activities.reduce((sum, a) => sum + a.effort, 0);
            const startDateFormatted = new Date(2023, 0, 1 + minStart).toISOString().split('T')[0];
            const endDateFormatted = new Date(2023, 0, 1 + maxEnd).toISOString().split('T')[0];

            document.getElementById('summary').innerHTML = `
                <table>
                    <tr><th>Start Date</th><td>${startDateFormatted}</td></tr>
                    <tr><th>End Date</th><td>${endDateFormatted}</td></tr>
                    <tr><th>Total Budget</th><td>Â£${totalCost.toFixed(2)}</td></tr>
                    <tr><th>Internal Cost</th><td>Â£${internalCost.toFixed(2)}</td></tr>
                    <tr><th>External Cost</th><td>Â£${externalCost.toFixed(2)}</td></tr>
                    <tr><th>Total Internal Staff Tasks</th><td>${internalStaffTotal}</td></tr>
                    <tr><th>Total External Staff Tasks</th><td>${externalStaffTotal}</td></tr>
                    <tr><th>Total Duration</th><td>${totalDuration >= 0 ? totalDuration : 0} days</td></tr>
                    <tr><th>Total Effort</th><td>${totalEffort} days</td></tr>
                    <tr><th>Internal Effort</th><td>${internalEffort} days</td></tr>
                    <tr><th>External Effort</th><td>${externalEffort} days</td></tr>
                </table>
            `;

            const tasks = activities.map(a => ({
                id: a.id.toString(),
                name: `${a.name || `Activity ${a.id}`} (${a.owner || 'No owner'})`,
                start: new Date(2023, 0, 1 + a.start).toISOString().split('T')[0],
                end: new Date(2023, 0, 1 + a.end).toISOString().split('T')[0],
                progress: 0,
                dependencies: a.predecessors.join(','),
                custom_class: a.internalStaffCount > 0 && a.externalStaffCount > 0 ? 'mixed' : a.internalStaffCount > 0 ? 'internal' : 'external'
            }));

            const startDate = new Date(2023, 0, 1 + minStart);
            const endDate = new Date(2023, 0, 1 + maxEnd);

            document.getElementById('gantt').innerHTML = '';
            const gantt = new Gantt("#gantt", tasks, {
                header_height: 70,
                column_width: 30,
                step: 24,
                view_modes: ['Day'],
                bar_height: 20,
                padding: 18,
                start_date: startDate,
                end_date: endDate,
                custom_popup_html: null,
                on_date_change: function(task, start, end) {
                    const id = parseInt(task.id);
                    const activity = activities.find(a => a.id === id);
                    const baseDate = new Date(2023, 0, 1);
                    const newStartDays = Math.floor((start - baseDate) / (1000 * 60 * 60 * 24));
                    const effortDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    activity.desiredStartDate = start.toISOString().split('T')[0];
                    activity.effort = effortDays;
                    activity.start = newStartDays;
                    activity.end = addWorkDays(newStartDays, effortDays, activity.allowWeekendWork);
                    try {
                        computeSchedule();
                        renderActivitiesTable();
                        updateRoadmap();
                    } catch (error) {
                        alert('Invalid change: ' + error.message);
                        renderActivitiesTable();
                    }
                }
            });

            const svg = document.querySelector('.gantt .gantt-container svg');
            const dateRow = document.querySelector('.gantt .grid-header');
            if (svg && dateRow) {
                const columnWidth = 30;
                const startDateMs = startDate.getTime();
                const endDateMs = endDate.getTime();
                const dayLetters = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                const letterRow = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                letterRow.setAttribute('class', 'day-letters');

                for (let ms = startDateMs; ms <= endDateMs; ms += 24 * 60 * 60 * 1000) {
                    const date = new Date(ms);
                    const dayIndex = date.getDay();
                    const dayLetter = dayLetters[dayIndex];
                    const x = ((ms - startDateMs) / (24 * 60 * 60 * 1000)) * columnWidth + columnWidth / 2;
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', 60);
                    text.setAttribute('class', 'day-letter');
                    text.textContent = dayLetter;
                    letterRow.appendChild(text);
                }

                svg.insertBefore(letterRow, svg.querySelector('.grid-header').nextSibling);
            }
        }

        function computeSchedule() {
            activities.forEach(a => { a.start = null; a.end = null; });
            const activityMap = new Map(activities.map(a => [a.id, a]));
            const incoming = new Map(activities.map(a => [a.id, a.predecessors.length]));
            const queue = activities.filter(a => a.predecessors.length === 0).map(a => a.id);

            const baseDate = new Date(2023, 0, 1);
            const today = new Date();
            const todayDays = Math.floor((today - baseDate) / (1000 * 60 * 60 * 24));

            activities.forEach(a => {
                if (a.desiredStartDate) {
                    const date = new Date(a.desiredStartDate);
                    if (!isNaN(date.getTime())) {
                        a.desiredStartDays = Math.floor((date - baseDate) / (1000 * 60 * 60 * 24));
                    } else {
                        a.desiredStartDays = null;
                    }
                } else {
                    a.desiredStartDays = null;
                }
            });

            while (queue.length > 0) {
                const currentId = queue.shift();
                const current = activityMap.get(currentId);

                let earliestStart = current.predecessors.length === 0 
                    ? (current.desiredStartDays !== null ? current.desiredStartDays : todayDays)
                    : Math.max(...current.predecessors.map(predId => {
                        const pred = activityMap.get(predId);
                        if (!pred) throw new Error(`Invalid predecessor ID ${predId}`);
                        return pred.end;
                    }));

                current.start = current.desiredStartDays !== null && current.desiredStartDays >= earliestStart 
                    ? current.desiredStartDays 
                    : earliestStart;
                
                current.end = addWorkDays(current.start, current.effort, current.allowWeekendWork);

                activities.forEach(a => {
                    if (a.predecessors.includes(currentId)) {
                        incoming.set(a.id, incoming.get(a.id) - 1);
                        if (incoming.get(a.id) === 0) queue.push(a.id);
                    }
                });
            }

            const unscheduled = activities.filter(a => a.start === null);
            if (unscheduled.length > 0) {
                throw new Error('Cycle detected in dependencies. Please revise.');
            }
        }

        renderActivitiesTable();
    </script>
    <script>
        (function(){
            function c(){
                var b=a.contentDocument||a.contentWindow.document;
                if(b){
                    var d=b.createElement('script');
                    d.innerHTML="window.__CF$cv$params={r:'931bec5eecb1138e',t:'MTc0NDg5MjkxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
                    b.getElementsByTagName('head')[0].appendChild(d)
                }
            }
            if(document.body){
                var a=document.createElement('iframe');
                a.height=1;
                a.width=1;
                a.style.position='absolute';
                a.style.top=0;
                a.style.left=0;
                a.style.border='none';
                a.style.visibility='hidden';
                document.body.appendChild(a);
                if('loading'!==document.readyState)c();
                else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);
                else{
                    var e=document.onreadystatechange||function(){};
                    document.onreadystatechange=function(b){
                        e(b);
                        'loading'!==document.readyState&&(document.onreadystatechange=e,c())
                    }
                }
            }
        })();
    </script>
</body>
</html>
